
// let html = `
// <!DOCTYPE html>
// <html lang="en" blank="zzz" gggg>
// <style>
//   .test{font-size:20px;}
// </style>
// <head>
//   <meta charset="utf-8">
//   <meta http-equiv="X-UA-Compatible" content="IE=edge">
//   <meta name="viewport" content="width=device-width, initial-scale=1">
//   <link rel="icon" href="https://cdn.cocreate.app/favicon.ico" type="image/ico" sizes="16x16">
//   <title>CoCrate-builder Iframe | CoCreate</title>
//   <meta name="description" content="Utility first css framework, design faster and improve on your css by using native inline styles as classes. No learning curve, use what you already know" />
//   <meta name="keywords" content="helper classes, utility classes, css framework, css library, inline style classes" />
//   <meta name="robots" content="index,follow" />
//   <!-- CoCreate CSS -->
//   <link rel="stylesheet" href="https://server.cocreate.app/css/CoCreate.min.css" type="text/css" />
//   <link rel="stylesheet" href="https://server.cocreate.app/CoCreate-components/CoCreate-dnd/src/CoCreate-dnd.css" type="text/css" />
//   <!-- Font Awesome -->
//   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" crossorigin="anonymous" /> 
//     </head>
// <body data-group_name="canvas" class="sortable cocreate-scroll padding-20px height-unset " data-element_id="uXSkyENBJg150457">
//   <div data-element_id="KOwpiDknEi150457">
//     <h3 data-element_id="UOSXmIxqpp150457" class="test">Element List</h3>
//     <!--<h3 data-element_id="UOSXmIxqpp150457" class="test" data-collection="module_activities" data-document_id="5edda7608d5c7a7d656edecd" name="name">Element List</h3>-->
//     <div data-element_id="DXKWxRSIua150457">
//       <ul style="padding:20px;" data-element_id="BTDyibkoTt150457">
//         <li data-element_id="hvPhQgkfPy150457"><i class="fa fa-header" data-element_id="wMbFwmNDTK150457" data-name="" data-hoverable="true"></i>
//           <p data-element_id="CIjCdpmugU150457">Header</p>
//         </li>
//         <li data-element_id="RermOcDFwG150457"> <i class="fa fa-bar-chart" data-element_id="ZQenEPBhsE150457" data-name="" data-hoverable="true"></i>
//           <p data-element_id="ekQoVrkKdk150457" contenteditable>Chart Image</p>
//         </li>
//         <li data-element_id="HbcHnLofUV150457"> <i class="fa fa-sign-in" data-element_id="sAnZqodgEX150457" data-name="" data-hoverable="true"></i>
//           <p name="name1" data-element_id="QUZRBeyhMg150457" style="width: 100px" data-docuemnt_id="fff">Login Form</p>
//           <input class="floating-label" data-element_id="eacVXBRQPH150457">
//           <p name="name3"  data-element_id="OzUtQtzQhz150457">Login Form</p>
//           <p name="name4"  data-element_id="kxAFdDHHVA150457">Login Form</p>
//         </li>
//       </ul>
//     </div>
//   </div>
//   <div id="box" data-element_id="uUsyRrFkEG150457">
//     <div style=" padding: 20px;" data-element_id="LgZNKeRWft150457">
//       <div style=" padding: 20px;" data-element_id="wIQWXhRKOz150457">empty</div>
//     </div>
//   </div>
//           <!--<script defer src="https://server.cocreate.app/CoCreate-components/CoCreate-domReader/src/index.js"></script>-->
//   <script>
//     var config = {
//       apiKey: 'c2b08663-06e3-440c-ef6f-13978b42883a',
//       securityKey: 'f26baf68-e3a9-45fc-effe-502e47116265',
//       organization_Id: '5de0387b12e200ea63204d6c'
//     }
//   </script>
//   <script defer src="https://server.cocreate.app/js/CoCreate.min.js"></script>
//         <!--<script defer src="https://server.cocreate.app/CoCreate-components/CoCreate-htmltags/src/CoCreate-htmltags.js"></script>-->

//   <!--<script defer src="https://server.cocreate.app/CoCreate-components/CoCreate-boxmarker/src/CoCreate-boxmarker.js"></script>-->
//     <!--<script src="https://server.cocreate.app/CoCreate-components/CoCreate-observer/src/index.js"></script>-->
//             <script defer src="https://server.cocreate.app/CoCreate-components/CoCreate-selected2/src/index.js"></script>
//   <!--<script defer src="https://server.cocreate.app/CoCreate-components/CoCreate-domEditor/src/element-config.js"></script>-->
// </body>
// </html>

// `;

// let findpos = new findPosition({
//   html, // html String
//   tagName: "ul",
//   target: "BTDyibkoTt150457",
//   method: "setAttribute",
//   //  property: "data-element_id",
//   property: "rand",
// });

// let findpos = new findPosition({
//   html, // html String
//   tagName: "ul",
//   target: "BTDyibkoTt150457",
//   method: "setAttribute",
//   //  property: "data-element_id",
//   property: "data-element-ddddd",
// });
// new findPosition({
//   html, // html String
//   tagName: "ul",
//   target: "BTDyibkoTt150457",
//   method: "style.set",
//   property: "background",
// });
// new findPosition({
//   html, // html String
//   tagName: "ul",
//   target: "BTDyibkoTt150457",
//   method: "style.set",
//   property: "padding",
// });

// new findPosition({
//   html, // html String
//   tagName: "div",
//   target: "DXKWxRSIua150457",
//   method: "style.set",
//   property: "padding",
// });

// new findPosition({
//   html, // html String
//   tagName: "ul",
//   target: "BTDyibkoTt150457",
//   method: "class.set",
//   property: "my-class-name",
// });

// new findPosition({
//   html, // html String
//   tagName: "ul",
//   target: "BTDyibkoTt150457",
//   nextSibling: "fff",
//   skip: 1,
//   method: "insertAdjacentElement",
//   property: "beforeend",
// });

// new findPosition({
//   html, // html String
//   tagName: "a",
//   target: "gggg",
//   method: "setAttribute",

// });

// new findPosition({
//   html, // html String
//   tagName: "ul",
//   target: "BTDyibkoTt150457",
//   nextSibling: "fff",
//   skip: 1,
//   method: "removeElement",

// });
// new findPosition({
//   html, // html String
//   tagName: "ButtoN",
//   target: "PmhlBVHsFj143820",
//   method: "setAttribute",
// });

// new findPosition({
//   html, // html String
//   method: "removeElement",
//   nextSibling: "kxAFdDHHVA150457",
//   skip: 0,
//   tagName: "P",
//   target: "OzUtQtzQhz150457"
// });

// let unconditinalTag = ["br"];
function findPosition({
  html,
  tagName: realTagName,
  target,
  method,
  property,
  nextSibling,
  skip,
}) {
  realTagName = realTagName.toLowerCase();
  // regex
  this.getRegAttribute = (attributeName) =>
    `(?:${spa}${attributeName}(?:="[^"]*?")?${sps})`;
  this.getRegStyle = (styleName) =>
    `(?:${sps}${styleName}${sps}\:${sps}[^\;]+?${sps};${sps})`;
  this.getRegClass = (className) => `(?:${sps}${className}${sps})`;
  this.getTagClose = (tagName) => `(?:${sps}\/${sps}${tagName}${sps})`;
  this.getRegTagStart = (tagName) => `(?:<${tagName}${sps})`;
  // &todo: wrong * make it +, done, is it correct?
  let space = "(?:\u{0020}|\u{0009}|\u{000A}|\u{000C}|\u{000D})";
  // let space = " ";
  let allAttributeName = `[^${space}\=\>]+`;
  let allStyleName = '[^"]+?';
  let allClassName = allStyleName;

  let sps = `${space}*?`;
  let spa = `${space}+?`;

  let at = this.getRegAttribute(allAttributeName);

  let tgs = `(?:<(?<tagName>[a-z0-9]+?)${sps})`;

  let sch = `(?:${sps}data-element_id\=\"${target}\"${sps})`;

  // todo: check with a tag like <a />
  let the = `(?<tagSlash>\/)?>`;

  let closingTag = `<${sps}/${realTagName}>`;

  let sty = this.getRegStyle(allStyleName);
  let msty = `${sty}*?`;

  let cls = this.getRegClass(allClassName);
  let mcls = `${cls}*?`;

  let revTag = realTagName.split("").reverse().join("");
  let backCloseTag = `(?<closeTag>>${revTag}${sps}\/${sps}<)`;
  
  
  this.findStartTag = (html) => {

    let reg = `(?<tagWhole>${tgs}${at}*?${sch}${at}*?${the})`;
    let tagStart = html.match(
      new RegExp(reg, "is")
    );


    if (!tagStart) throw new Error("findPosition: element can not be found");
    
    if (tagStart && tagStart.groups.tagName.toLowerCase() !== realTagName)
      throw new Error(
        "findPosition: tag name didn't match, something is wrong"
      );
    this.tagName = tagStart.groups.tagName.toLowerCase();
    this.tagStPos = tagStart.index;
    this.tagStAfPos = tagStart.index + realTagName.length + 1;
    this.tagStClPos =
      tagStart.index +
      tagStart.groups.tagWhole.length -
      1 -
      (tagStart.groups.tagSlash ? 1 : 0);
    this.tagStClAfPos = tagStart.index + tagStart.groups.tagWhole.length;
    if(tagStart.groups.tagSlash)
    {
        this.tagEnPos = this.tagStClPos;;
        this.tagEnClAfPos = this.tagStClAfPos;
    }
  };
  // metadata
  this.tagStPos;
  this.tagStAfPos;
  this.tagStClPos;
  this.tagStClAfPos;
  this.tagEnPos;
  this.tagEnClPos;
  this.atSt;
  this.atEn;

  this.tagEnPos;
  this.tagEnClAfPos;

  this.lastStart;
  this.offset;

  this.getWholeElement = () => {
    if (!this.tagStPos) this.findStartTag(html);
    if (!this.tagEnPos) this.findClosingTag();

    return { from: this.tagStPos, to: this.tagEnClAfPos };
  };
  this.findClosingTag = () => {
    let reverseHtml = html.split("").reverse().join("");
    let start;
    
    if (nextSibling) {
      start = reverseHtml.indexOf(`"${nextSibling.split("").reverse().join("")}"=di_tnemele-atad `);
      if(start === -1)
        throw new Error('could not found next sibiling ' + nextSibling + ' in the html');
      reverseHtml = reverseHtml.substr(start);
    }

    let found = reverseHtml.matchAll(new RegExp(backCloseTag, "isg"));

    let match = Array.from(found)[skip];
    if (!match) throw new Error("couldn't find the end tag");
    this.tagEnClAfPos = html.length - match.index - start;
    this.tagEnPos = this.tagEnClAfPos - match[0].length;
  };


  this.getInsertAdjacentElement = (property) => {
    if (!this.tagStPos) this.findStartTag(html);
    switch (property) {
      case "beforebegin":
        return { from: this.tagStPos };
        break;
      case "afterbegin":
        return { from: this.tagStClAfPos };
        break;
      case "beforeend":
        this.findClosingTag();
        return { from: this.tagEnPos };
        break;
      case "afterend":
        this.findClosingTag();
        return { from: this.tagEnClAfPos };
        break;
    }

    html.substr(this.tagStClAfPos);
  };

  this.getClass = (property, method2) => {
    this.findAttribute(html, "class", true);
    if (this.atEn) {
      let positions = this.findClassPos(html, property);
      return { ...positions, context: "value" };
    }
    // for set or remove
    else return { from: this.atSt, context: "attribute" };
  };
  this.findClassPos = (html, property) => {
    let prRegClass = this.getRegClass(property);
    // console.log(prRegStyle);return;
    let classStart = html
      .substring(this.atSt, this.atEn)
      .match(
        new RegExp(`^(?<styleWhole>${mcls})(?<ourStyle>${prRegClass})`, "is")
      );

    if (classStart && classStart.groups.ourStyle)
      return {
        from: this.atSt + classStart.groups.styleWhole.length,
        to:
          this.atSt +
          classStart.groups.styleWhole.length +
          classStart.groups.ourStyle.length,
      };
    else
      return {
        from: this.atEn,
      };
  };
  this.getStyle = (property, method2) => {
    this.findAttribute(html, "style", true);
    if (this.atEn) {
      let positions = this.findStylePos(html, property);
      return { ...positions, context: "value" };
    }
    // for set or remove
    else return { from: this.atSt, context: "attribute" };
  };
  this.findStylePos = (html, property) => {
    let prRegStyle = this.getRegStyle(property);
    // console.log(prRegStyle);return;
    let styleStart = html
      .substring(this.atSt, this.atEn)
      .match(
        new RegExp(`^(?<styleWhole>${msty})(?<ourStyle>${prRegStyle})`, "is")
      );

    if (styleStart && styleStart.groups.ourStyle)
      return {
        from: this.atSt + styleStart.groups.styleWhole.length,
        to:
          this.atSt +
          styleStart.groups.styleWhole.length +
          styleStart.groups.ourStyle.length,
      };
    else
      return {
        from: this.atEn,
      };
  };

  this.findAttribute = (html, property, isValueOnly) => {
    if (!this.tagStAfPos) this.findStartTag(html);

    let prRegAttr = this.getRegAttribute(property);
    let regex = `^(?<beforeAtt>${at}*?)${prRegAttr}`;

    let attStart = html.substr(this.tagStAfPos).match(new RegExp(regex, "is"));

    if (attStart) {
      this.atSt =
        this.tagStAfPos +
        attStart.groups.beforeAtt.length +
        (isValueOnly ? 3 + property.length : 0);

      let tagEnd = html
        .substr(this.atSt)
        .match(new RegExp('(?<attEnd>^[^"]*?")', "is"));
      this.atEn =
        this.atSt + tagEnd.groups.attEnd.length - (isValueOnly ? 1 : 0);
    } else {
      this.atSt = this.tagStClPos;
    }
  };

  this.getSetAttribute = (property, type) => {
    switch (type) {
      case "get":
      case "set":
        this.findAttribute(html, property, true);
        break;
      case "remove":
        this.findAttribute(html, property);
        break;
    }
    return { from: this.atSt, to: this.atEn };
  };

  this.scanMethods = () => {
    let [method1, method2] = method.split(".");
    switch (method1) {
      case "insertAdjacentElement":
        return this.getInsertAdjacentElement(property);
        break;
      case "class":
        return this.getClass(property, method2);
        break;
      case "style":
        return this.getStyle(property, method2);
        break;
      case "setAttribute":
        return this.getSetAttribute(property, "set");
        break;
      case "getAttribute":
        return this.getSetAttribute(property, "get");
        break;
      case "removeAttribute":
        return this.getSetAttribute(property, "remove");
        break;
      case "removeElement":
        return this.getWholeElement();
        break;
      default:
        throw new Error("findPosition: method is not supported");
    }
  };
  
  function logFindPosition(p ){

      console.log({
  html,
  method,
  nextSibling,
  skip,
  realTagName,
  target
},"=================start=====================>>>>>>>>>>>>>>>>>>>");
    if (p.to) {


      console.log('%s%c<from>%c%s%c<to>%c%s',
        html.substring(p.from - 20, p.from) ,
      'color: red', 'color: white',
          html.substring(p.from, p.to) ,
        'color: red', 'color: white',
          html.substring(p.to, p.to + 20),
      );
    } else {
     
      // console.log(html.substring(p.from, p.from + 20));
      console.log(
        '%s%c<here>%c%s',
        html.substring(p.from - 20, p.from) 
          ,'color: red', 'color: white',
          html.substring(p.from, p.from + 40)
      );
    }
    console.log("==================end====================");
}
  function logFindPositionNodeJs(p ){

      console.log("=================start=====================>>>>>>>>>>>>>>>>>>>");
     if (p.to) {


      console.log(html.substring(p.from - 20, p.from) +'\x1b[31m<from>\x1b[0m' + 
      html.substring(p.from , p.to) + '\x1b[31m<to>\x1b[0m' +  html.substring(p.to , p.to + 20)
     
      );
    } else {
          console.log(html.substring(p.from - 20, p.from)  +'\x1b[31m<from>\x1b[0m' + 
          html.substring(p.from, p.from + 40))
     
    }
    console.log("==================end====================");
}
  
  try {
    let p = this.scanMethods();
    console.log(p, method,html.length)
    // logFindPositionNodeJs(p)
    logFindPosition(p)
    return p;
  } catch (err) {
    console.error(err);
  }
}
/*

   CoCreate.deleteDataCrdt({
  	collection: 'module_activities',
  	document_id: '5edda7608d5c7a7d656edecd',
  	name: 'html',
  	position:0,
  	length:36,
  })

  CoCreate.insertDataCrdt({
  	collection: 'module_activities',
  	document_id: '5edda7608d5c7a7d656edecd',
  	name: 'html',
  	value: '<h1 data-element_id="t1">test 1</h1>',
  	position:75,
  })
  
   CoCreate.deleteDataCrdt({
  	collection: 'module_activities',
  	document_id: '5edda7608d5c7a7d656edecd',
  	name: 'html',
  	position:75,
  	length:36,
  })
  
  CoCreate.insertDataCrdt({
  	collection: 'module_activities',
  	document_id: '5edda7608d5c7a7d656edecd',
  	name: 'html',
  	value: '<h1 data-element_id="t1">test 1</h1>',
  	position:0,
  })


  CoCreate.getDataCrdt({
  	collection: 'module_activities',
  	document_id: '5edda7608d5c7a7d656edecd',
  	name: 'html'
  })
 
  
*/